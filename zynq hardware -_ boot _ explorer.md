                                      var NexT = window.NexT || {}; var CONFIG = { root: '/', scheme: 'Gemini', version: '5.1.4', sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false}, fancybox: true, tabs: true, motion: {"enable":true,"async":false,"transition":{"post\_block":"fadeIn","post\_header":"slideDownIn","post\_body":"slideDownIn","coll\_header":"slideLeftIn","sidebar":"slideUpIn"}}, duoshuo: { userId: '0', author: 'Author' }, algolia: { applicationID: '', apiKey: '', indexName: '', hits: {"per\_page":10}, labels: {"input\_placeholder":"Search for Posts","hits\_empty":"We didn't find any results for the search: ${query}","hits\_stats":"${hits} results found in ${time} ms"} } };  zynq hardware -> boot | explorer  (function(i,s,o,g,r,a,m){i\['GoogleAnalyticsObject'\]=r;i\[r\]=i\[r\]||function(){ (i\[r\].q=i\[r\].q||\[\]).push(arguments)},i\[r\].l=1\*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)\[0\];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', '112423075-1', 'auto'); ga('send', 'pageview');   var \_hmt = \_hmt || \[\]; (function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?2ab4cc06d0da36106a4426465d0cb00d"; var s = document.getElementsByTagName("script")\[0\]; s.parentNode.insertBefore(hm, s); })();  .v \*{-webkit-box-sizing:border-box;box-sizing:border-box;line-height:2;color:#555;-webkit-transition:all .3s ease;transition:all .3s ease}.v hr{margin:.825rem 0;border-color:#f6f6f6;border-style:dashed}.v.hide-avatar .vimg{display:none}.v a{position:relative;cursor:pointer;color:#1abc9c;display:inline-block}.v a:before{content:"";position:absolute;width:0;right:0;bottom:0;height:1px;background:#1abc9c;-webkit-transition:width .3s ease;transition:width .3s ease}.v a:hover{color:#d7191a}.v a:hover:before{width:100%;left:0;right:auto}.v code,.v pre{background-color:#f6f6f6;color:#555;padding:.2em .4em;border-radius:3px;font-size:85%;margin:0;font-family:Source Code Pro,courier new,Input Mono,PT Mono,SFMono-Regular,Consolas,Monaco,Menlo,PingFang SC,Liberation Mono,Microsoft YaHei,Courierï¼Œmonospace}.v pre{padding:10px;overflow:auto;line-height:1.45}.v pre code{padding:0;background:transparent;white-space:pre-wrap;word-break:keep-all}.v blockquote{color:#666;margin:.5rem 0;padding:0 0 0 1rem;border-left:8px solid hsla(0,0%,93%,.5)}.v .vinput{border:none;resize:none;outline:none;padding:10px 5px;max-width:100%;font-size:.775rem}.v input\[type=checkbox\],.v input\[type=radio\]{display:inline-block;vertical-align:middle;margin-top:-2px}.v .vwrap{border:1px solid #f0f0f0;border-radius:4px;margin-bottom:10px;overflow:hidden;position:relative;padding:10px}.v .vwrap input{background:transparent}.v .vwrap .vedit{position:relative;padding-top:10px}.v .vwrap .vedit .vctrl{text-align:right;font-size:12px}.v .vwrap .vedit .vctrl span{padding:10px;display:inline-block;vertical-align:middle;cursor:pointer}.v .vwrap .vedit .vemojis{display:none;font-size:18px;text-align:justify;max-height:145px;overflow:auto;margin-bottom:10px;-webkit-box-shadow:0 0 1px #f0f0f0;box-shadow:0 0 1px #f0f0f0}.v .vwrap .vedit .vemojis i{font-style:normal;padding:7px 0;width:38px;cursor:pointer;text-align:center;display:inline-block;vertical-align:middle}.v .vwrap .vedit .vpreview{padding:7px;-webkit-box-shadow:0 0 1px #f0f0f0;box-shadow:0 0 1px #f0f0f0}.v .vwrap .vedit .vpreview frame,.v .vwrap .vedit .vpreview iframe,.v .vwrap .vedit .vpreview img{max-width:100%;border:none}.v .vwrap .vheader .vinput{width:33.33%;border-bottom:1px dashed #dedede}.v .vwrap .vheader.item2 .vinput{width:50%}.v .vwrap .vheader.item1 .vinput{width:100%}.v .vwrap .vheader .vinput:focus{border-bottom-color:#eb5055}@media screen and (max-width:520px){.v .vwrap .vheader.item2 .vinput,.v .vwrap .vheader .vinput{width:100%}}.v .vwrap .vcontrol{font-size:0;padding-top:15px}.v .vwrap .vcontrol .col{display:inline-block;font-size:.725rem;vertical-align:middle;color:#ccc}.v .vwrap .vcontrol .col.text-right{text-align:right}.v .vwrap .vcontrol .col svg{margin-right:2px;overflow:hidden;fill:currentColor;vertical-align:middle}.v .vwrap .vcontrol .col.col-20{width:20%}.v .vwrap .vcontrol .col.col-40{width:40%}.v .vwrap .vcontrol .col.col-60{width:60%}.v .vwrap .vcontrol .col.col-80{width:80%}.v .vwrap .vcontrol .col.split{width:50%}.v .vwrap .vmark{position:absolute;background:rgba(0,0,0,.65);width:100%;height:100%;left:0;top:0}.v .vwrap .vmark .valert{padding-top:3rem}.v .vwrap .vmark .valert .vtext{color:#fff;padding:1rem 0}.v .vwrap .vmark .valert .vcode{width:4.6875rem;border-radius:.3125rem;padding:.5rem;background:#dedede}.v .vwrap .vmark .valert .vcode:focus{border-color:#3090e4;background-color:#fff}@media screen and (max-width:720px){.v .vwrap .vmark .valert{padding-top:5.5rem}.v .vwrap .vmark .valert .vtext{color:#fff;padding:1rem 0}}.v .power{color:#999;padding:.5rem 0}.v .power,.v .power a{font-size:.75rem}.v .vinfo{font-size:0;padding:5px}.v .vinfo .col{font-size:.875rem;display:inline-block;width:50%;vertical-align:middle}.v .vinfo .vcount .vnum{font-weight:600;font-size:1.25rem}.v a{text-decoration:none;color:#555}.v a:hover{color:#222}.v ol,.v ul{padding:0;margin-left:1.25rem}.v .txt-center{text-align:center}.v .txt-right{text-align:right}.v .pd5{padding:5px}.v .pd10{padding:10px}.v .veditor{width:100%;min-height:8.75rem;font-size:.875rem;background:transparent;resize:vertical;-webkit-transition:all .25s ease;transition:all .25s ease}.v .vbtn{-webkit-transition-duration:.4s;transition-duration:.4s;text-align:center;color:#313131;border:1px solid #ededed;border-radius:.3rem;display:inline-block;background:#ededed;margin-bottom:0;font-weight:400;vertical-align:middle;-ms-touch-action:manipulation;touch-action:manipulation;cursor:pointer;white-space:nowrap;padding:.5rem 1.25rem;font-size:.875rem;line-height:1.42857143;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;outline:none}.v .vbtn+.vbtn{margin-left:1.25rem}.v .vbtn:active,.v .vbtn:hover{color:#3090e4;border-color:#3090e4;background-color:#fff}.v .vempty{padding:1.25rem;text-align:center;color:#999}.v .vlist{width:100%}.v .vlist .vcard{padding-top:1.5rem;position:relative;display:block}.v .vlist .vcard:after{content:"";clear:both;display:block}.v .vlist .vcard .vimg{width:3.125rem;height:3.125rem;float:left;border-radius:50%;margin-right:.7525rem;border:1px solid #f5f5f5;padding:.125rem}@media screen and (max-width:720px){.v .vlist .vcard .vimg{width:2.5rem;height:2.5rem}}.v .vlist .vcard .vhead{line-height:1.5;margin-top:0}.v .vlist .vcard .vhead .vnick{position:relative;font-size:.875rem;font-weight:500;margin-right:.875rem;cursor:pointer;color:#1abc9c;text-decoration:none;display:inline-block}.v .vlist .vcard .vhead .vnick:before{content:"";position:absolute;width:0;right:0;bottom:0;height:1px;background:#1abc9c;-webkit-transition:width .3s ease;transition:width .3s ease}.v .vlist .vcard .vhead .vnick:hover{color:#d7191a}.v .vlist .vcard .vhead .vnick:hover:before{width:100%;left:0;right:auto}.v .vlist .vcard .vhead .vsys{display:inline-block;padding:.2rem .5rem;background:#ededed;color:#b3b1b1;font-size:.75rem;border-radius:.2rem;margin-right:.3rem}@media screen and (max-width:520px){.v .vlist .vcard .vhead .vsys{display:none}}.v .vlist .vcard .vh{overflow:hidden;padding-bottom:.5rem;border-bottom:1px dashed #f5f5f5}.v .vlist .vcard .vh .vtime{color:#b3b3b3;font-size:.75rem;margin-right:.875rem}.v .vlist .vcard .vh .vmeta{line-height:1;position:relative}.v .vlist .vcard .vh .vmeta .vat{font-size:.8125rem;color:#ef2f11;cursor:pointer;float:right}.v .vlist .vcard .vcontent{word-wrap:break-word;word-break:break-all;text-align:justify;color:#4a4a4a;font-size:.875rem;line-height:2;position:relative;margin-bottom:.75rem;padding-top:.625rem}.v .vlist .vcard .vcontent frame,.v .vlist .vcard .vcontent iframe,.v .vlist .vcard .vcontent img{max-width:100%;border:none}.v .vlist .vcard .vcontent.expand{cursor:pointer;max-height:11.25rem;overflow:hidden}.v .vlist .vcard .vcontent.expand:before{display:block;content:"";position:absolute;width:100%;left:0;top:0;bottom:3.15rem;pointer-events:none;background:-webkit-gradient(linear,left top,left bottom,from(hsla(0,0%,100%,0)),to(hsla(0,0%,100%,.9)));background:linear-gradient(180deg,hsla(0,0%,100%,0),hsla(0,0%,100%,.9))}.v .vlist .vcard .vcontent.expand:after{display:block;content:"Click on expand";text-align:center;color:#828586;position:absolute;width:100%;height:3.15rem;line-height:3.15rem;left:0;bottom:0;pointer-events:none;background:hsla(0,0%,100%,.9)}.v .vlist .vcard .vquote{color:#666;margin-top:1rem;padding-left:1rem;border-left:1px dashed hsla(0,0%,93%,.5)}.v .vlist .vcard .vquote .vimg{width:2.225rem;height:2.225rem}.v .vpage .vmore{margin:1rem 0}.v .clear{content:"";display:block;clear:both}@-webkit-keyframes spin{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}to{-webkit-transform:rotate(1turn);transform:rotate(1turn)}}@keyframes spin{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}to{-webkit-transform:rotate(1turn);transform:rotate(1turn)}}@-webkit-keyframes pulse{50%{background:#dcdcdc}}@keyframes pulse{50%{background:#dcdcdc}}.v .vloading{position:relative;padding:20px;display:block;height:80px}.v .vloading:before{-webkit-box-sizing:border-box;box-sizing:border-box;content:"";position:absolute;display:inline-block;top:20px;left:50%;margin-left:-20px;width:40px;height:40px;border:6px double #a0a0a0;border-top-color:transparent;border-bottom-color:transparent;border-radius:50%;-webkit-animation:spin 1s infinite linear;animation:spin 1s infinite linear}.fancybox-margin{margin-right:17px;}

[explorer](http://kcmetercec.top/)

ä¸‡ä¸ˆé«˜æ¥¼å¹³åœ°èµ·ï¼Œå‹¿åœ¨æµ®æ²™ç­‘é«˜å°

*   [  
    Home](http://kcmetercec.top/)
*   [  
    About](http://kcmetercec.top/about/)
*   [  
    Tags](http://kcmetercec.top/tags/)
*   [  
    Categories](http://kcmetercec.top/categories/)
*   [  
    Archives](http://kcmetercec.top/archives/)
*   [  
    Search](javascript:;)

       

zynq hardware -> boot
=====================

Posted on 2018-11-08 | In [processor](http://kcmetercec.top/categories/processor/) , [zynq](http://kcmetercec.top/categories/processor/zynq/) , [hardware](http://kcmetercec.top/categories/processor/zynq/hardware/) | [0](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#comments) | Visitors: 34

æ•´ç†zynqçš„ç¡¬ä»¶å¯åŠ¨æµç¨‹ã€‚

æ•´ä½“æµç¨‹
----

### æ¦‚è§ˆ

zynqçš„æ•´ä½“å¯åŠ¨æµç¨‹å¦‚ä¸‹å›¾:

[![boot.jpg](./zynq hardware -_ boot _ explorer_files/boot.jpg)](./zynq hardware -_ boot _ explorer_files/boot.jpg)

*   é™¤äº†ä»¥ä¸Šçš„å¯åŠ¨æ–¹å¼å¤–ï¼Œåœ¨è°ƒè¯•é˜¶æ®µï¼Œå¯ä»¥é€šè¿‡JTAGæŽ¥å£ä»¥éžå®‰å…¨æ¨¡å¼ä¸‹å¯åŠ¨ã€‚
    *   è¿™æ ·JTAGæ‰å¯ä»¥è®¿é—®ARM debug access port(DAP)ä»¥åŠ Xilinx test access port(TAP) æ¥åˆ†åˆ«è°ƒè¯•ARMå’ŒPL.
*   åœ¨å®‰å…¨æ¨¡å¼ä¸‹ï¼Œä»£ç æ˜¯è¢«äº‹å…ˆåŠ å¯†è¿‡çš„ï¼ŒBootROMä¼šé€šè¿‡DMAå°†fsblè¯»åˆ°OCMä¸­åŽè¢«CPUæ‰§è¡Œã€‚
    *   åœ¨è¿™ä¸­é—´ä¼šç»è¿‡AES(Advanced Encryption Standard)/HMAC(Hash-based Message Authentication Code)å•å…ƒè¿›è¡Œè§£å¯†ã€‚
*   åœ¨éžå®‰å…¨æ¨¡å¼ä¸‹ï¼ŒBootROMæ ¹æ®åŒ…å¤´æ¥ç¡®å®šæ˜¯å¦éœ€è¦å°†fsblæ‹·è´åˆ°OCMä¸­æ‰§è¡Œã€‚
*   å¦‚æžœBootROMæ²¡æœ‰åœ¨è®¾å¤‡åˆ°æ‰¾åˆ°åˆæ³•çš„è½¯ä»¶åŒ…å¤´ï¼Œå®ƒä¼šä¾æ¬¡å¯»æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°äº†æˆ–éåŽ†å®Œè¿™ä¸ªè®¾å¤‡ç©ºé—´ã€‚
    *   åªä¼šåœ¨QSPI,NAND,NORä¸­è¿™æ ·åšï¼Œåœ¨SDå¡ä¸­å¦‚æžœå¤±è´¥äº†åˆ™ä¸ä¼šå¯»æ‰¾äº†ã€‚
*   PLå¯åŠ¨åˆ†ä»¥ä¸‹4ä¸ªé˜¶æ®µ:
    *   ä¸Šç”µå¯åŠ¨
    *   åˆå§‹åŒ–:æ¸…ç©ºSRAMï¼Œå‡†å¤‡çƒ§å†™bitæ–‡ä»¶
    *   é…ç½®: é…ç½®PS-PLæŽ¥å£
    *   ä½¿èƒ½: BOOTROMä¼šè¯»å–PLçš„å¯åŠ¨çŠ¶æ€æ¥ç¡®å®šä½•æ—¶ä½¿èƒ½PLç«¯çš„JTAGã€‚

### PSç«¯ç¡¬ä»¶å¯åŠ¨

PSç«¯ç¡¬ä»¶å¯åŠ¨åŒ…å«ä¸Šç”µæ—¶åºã€æ—¶é’ŸèŽ·å–ã€å¤ä½ã€å¯åŠ¨ç®¡è„šé‡‡æ ·ã€PLLåˆå§‹åŒ–ã€‚åœ¨PSå¯åŠ¨æ—¶PLä¹Ÿå¯åŒæ—¶å¯åŠ¨ã€‚

åœ¨PSå¯åŠ¨åŽçš„å‡ ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œå®ƒå°†ä¼šè¯»å–MIO2~8çš„é…ç½®æ¨¡å¼å¹¶å°†é…ç½®å­˜å‚¨åˆ°åªè¯»å­˜å‚¨å™¨ä¸­ã€‚

*   å…¶ä¸­MIO6æ¥å†³å®šæ˜¯å¦ä½¿èƒ½PLLï¼Œå¦‚æžœä½¿èƒ½äº†PLLï¼Œé‚£ä¹ˆç³»ç»Ÿå°†è¦ç­‰å¾…PLLç¨³å®šåŽæ‰å¯åŠ¨BOOTROM.

å¦‚æžœæ²¡æœ‰ä½¿èƒ½åˆ™ä¼šç›´æŽ¥ä½¿ç”¨å¤–éƒ¨æ™¶æŒ¯çš„é¢‘çŽ‡ã€‚

### PSç«¯è½¯ä»¶å¯åŠ¨

PSæ®µè½¯ä»¶ä¸Šæ•´ä½“æµç¨‹ä¸ºï¼š

1.  BootROMæ ¹æ®å¯åŠ¨å¼•è„šå†³å®šä»Žå“ªä¸ªä»‹è´¨è¯»å‡ºBOOTåŒ…
    *   åœ¨CPU0ä¸Šè¿è¡Œï¼ŒCPU1å¤„äºŽç­‰å¾…äº‹ä»¶çŠ¶æ€(WFE)
    *   BootROMæ˜¯ç¡¬ç¼–ç çš„ä»£ç ï¼Œæ— æ³•æ”¹å˜
2.  BootROMåˆ†æžBOOTåŒ…å¤´æ¥ç¡®è®¤æ˜¯å¦è¦æ¬ç§»ä»£ç åˆ°OCM
3.  è¿è¡ŒFSBLæˆ–è£¸æœºä»£ç 
    *   FSBL æ˜¯å®Œå…¨å¯æ›´æ”¹çš„
4.  è¿è¡ŒSSBLæˆ–è£¸æœºä»£ç æˆ–ç³»ç»Ÿ
5.  è¿è¡Œç³»ç»Ÿ

### å¯åŠ¨ä»‹è´¨çš„å†…å®¹

é€šå¸¸çš„å¯åŠ¨åŒ…åŒ…å«ä¸‹é¢çš„å†…å®¹:

*   bootrom å¤´ï¼Œç”¨äºŽbootromåˆ†æž
*   fsbl/è£¸æœºä»£ç ï¼Œç”¨äºŽbootromæ¬ç§»
*   PLç«¯çš„bitæ–‡ä»¶ï¼Œç”¨äºŽåŽç»­ä»£ç ç»™PLçƒ§å†™
*   ssbl/è£¸æœºä»£ç /æˆ–ç³»ç»Ÿï¼Œç”¨äºŽfsblè·³è½¬åˆ°æ­¤æ‰§è¡Œ

### å¯åŠ¨æ¨¡å¼

zynqæ”¯æŒ4ç§ä¸»åŠ¨å¯åŠ¨æ–¹å¼ï¼š

1.  QSPI
    *   å¯ä»¥é€‰æ‹©æ˜¯å¦ç›´æŽ¥åœ¨QSPIä¸Šæ‰§è¡Œä»£ç ï¼Œè¿™æ ·å¯ä»¥å‡å°‘æ•°æ®æ¬ç§»è€Œæé«˜å¯åŠ¨é€Ÿåº¦
2.  NOR
    *   å¯ä»¥é€‰æ‹©æ˜¯å¦ç›´æŽ¥åœ¨NORä¸Šæ‰§è¡Œä»£ç ï¼Œè¿™æ ·å¯ä»¥å‡å°‘æ•°æ®æ¬ç§»è€Œæé«˜å¯åŠ¨é€Ÿåº¦
3.  SDå¡
4.  NAND

å¯ä»¥åœ¨[AR#50991](https://www.xilinx.com/support/answers/50991.html)ä¸­æŒ‘é€‰å®˜æ–¹æŽ¨èçš„èŠ¯ç‰‡ã€‚

zynqä¹Ÿæ”¯æŒè¢«åŠ¨å¯åŠ¨æ–¹å¼ï¼Œè¿™ç§æ–¹å¼æ˜¯éžåŠ å¯†æ¨¡å¼ï¼š

*   cascade JTAGæ¨¡å¼ï¼Œé»˜è®¤æ˜¯è¿™ç§æ–¹å¼
    *   å¯ä»¥é€šè¿‡PL JTAGè®¿é—®DAPå’ŒTAP
*   ç‹¬ç«‹ JTAGæ¨¡å¼1
    *   ä½¿ç”¨PL JTAGè®¿é—®TAPæ¥æŽ§åˆ¶PL
    *   åœ¨é…ç½®å®ŒPLåŽï¼Œä½¿ç”¨EMIO JTAGæ¥è®¿é—®DAPæŽ§åˆ¶ARM
*   ç‹¬ç«‹ JTAGæ¨¡å¼2
    *   ä½¿ç”¨PL JTAGè®¿é—®TAPæ¥æŽ§åˆ¶PL
    *   ä½¿ç”¨MIO JTAGè®¿é—®DAPæ¥æŽ§åˆ¶ARM

### BootROMçš„æ‰§è¡Œ

æ ¹æ®å‰é¢çš„è¯´æ˜Žå¯ä»¥çŸ¥é“:

1.  ç³»ç»Ÿçƒ­å¯åŠ¨çš„æƒ…å†µä¸‹ä¼šå¾ˆå¿«æ‰§è¡ŒBootROMï¼Œæ‰€ä»¥å…¶å¯åŠ¨æ—¶é—´æ›´çŸ­ã€‚
2.  BootROMåœ¨ä¸»åŠ¨å¯åŠ¨æ¨¡å¼ä¸‹ï¼Œå…·æœ‰å¯¹åº”æŽ§åˆ¶å™¨çš„åˆå§‹åŒ–åŠŸèƒ½ï¼Œè¿™æ ·æ‰èƒ½è¯»å–ä»‹è´¨å†…å®¹ã€‚

BootROMçš„å¤´æ¥å†³å®šæ˜¯å¦ä¸ºå®‰å…¨å¯åŠ¨æ¨¡å¼ï¼Œå¦‚æžœä¸ºå®‰å…¨å¯åŠ¨æ¨¡å¼ï¼ŒBootROMä¼šå°†ä»£ç ä»Žflashè¯»å‡ºã€è§£å¯†ã€å†™å…¥OCMã€‚

*   å¦‚æžœå®‰å…¨æ¨¡å¼ä¸‹çƒ­å¯åŠ¨ï¼Œå¤´æ ¼å¼è¢«éžæ³•ä¿®æ”¹ä¸ºéžå®‰å…¨æ¨¡å¼ï¼Œæ­¤æ—¶BootROMä¼šåœæ­¢é”æ­»ç³»ç»Ÿå¹¶æŠ¥é”™ 0x201A.
    *   æŠ¥é”™ç ä¼šå†™å…¥å¯„å­˜å™¨ `slcr.REBOOT_STATUS`

### PLçš„é…ç½®è·¯å¾„

[![pl_conf_path.jpg](./zynq hardware -_ boot _ explorer_files/pl_conf_path.jpg)](./zynq hardware -_ boot _ explorer_files/pl_conf_path.jpg)

å¦‚ä¸Šå›¾æ‰€ç¤ºPLæœ‰3ç§é…ç½®è·¯å¾„ï¼š

1.  JTAGè¿žæŽ¥TAPæŽ§åˆ¶å™¨
    *   ç”¨äºŽéžå®‰å…¨æ¨¡å¼
    *   éœ€è¦PLè¢«é…ç½®äºŽTAPæŽ¥å£
2.  PS PCAP æŽ§åˆ¶
    *   ç”¨äºŽå®‰å…¨å’Œéžå®‰å…¨æ¨¡å¼
    *   éœ€è¦PLè¢«é…ç½®äºŽDevcæŽ¥å£
3.  ICAPæŽ§åˆ¶
    *   ç”¨äºŽå®‰å…¨å’Œéžå®‰å…¨æ¨¡å¼
    *   éœ€è¦PLå·²ç»è¢«äº‹å…ˆä¸‹è½½äº†bitæµ

### è®¾å¤‡é…ç½®æŽ¥å£

[![devc_struct.jpg](./zynq hardware -_ boot _ explorer_files/devc_struct.jpg)](./zynq hardware -_ boot _ explorer_files/devc_struct.jpg)

zynqå…·æœ‰3ä¸ªè®¾å¤‡æŽ¥å£(DevC, device configuration interface)æ¥åˆ†åˆ«:

1.  é…ç½®PL
2.  ç®¡ç†è®¾å¤‡å®‰å…¨æ€§
3.  è®¿é—®XADC

ä¸Šç”µåˆ°bootrom
----------

### ç”µæºéœ€æ±‚

åœ¨è¿›å…¥bootromå‰ï¼Œéœ€è¦çš„ç”µæºéœ€æ±‚å¦‚ä¸‹å›¾:

[![power_requirements.jpg](./zynq hardware -_ boot _ explorer_files/power_requirements.jpg)](./zynq hardware -_ boot _ explorer_files/power_requirements.jpg)

### æ—¶é’Ÿ

å½“ä½¿èƒ½PLLæ—¶ï¼Œéœ€ç¡®ä¿å¤–éƒ¨æ™¶æŒ¯çš„ç¨³å®šã€‚å½“PLLæ—è·¯æ—¶ç³»ç»Ÿè¿è¡Œé€Ÿåº¦ä¼šé™ä½Žå¹¶ä¸”æœ‰äº›æ¨¡å—ä¹Ÿæ— æ³•ä½¿ç”¨ï¼ˆæ¯”å¦‚USBï¼‰ã€‚

### å¤ä½

æœ‰ä»¥ä¸‹ä¸¤ç§å¤ä½ï¼š

*   POR Reset(å†·å¯åŠ¨å¤ä½):å¤ä½æ•´ä¸ªç³»ç»Ÿ
*   Non-POR Resets(çƒ­å¯åŠ¨å¤ä½):ä»…å¤ä½éƒ¨åˆ†

### å¯åŠ¨æ¨¡å¼ç®¡è„š

[![boot_mode.jpg](./zynq hardware -_ boot _ explorer_files/boot_mode.jpg)](./zynq hardware -_ boot _ explorer_files/boot_mode.jpg)

åœ¨å¤ä½åŽç¡¬ä»¶å°†ä¼šé‡‡æ ·è¿™å‡ ä¸ªç®¡è„šå€¼ï¼Œç„¶åŽå­˜å‚¨äºŽåªè¯»å¯„å­˜å™¨:

*   BOOT\_MODE\[4:0\] å­˜å‚¨äºŽ `slcr.BOOT_MODE[BOOT_MODE],[PLL_BYPASS]` ä¸­
*   VMODE\[1:0\] å­˜å‚¨äºŽ `slcr.GPIOB_DRVR_BIAS_CTRL[RB_VCFG],[LB_VCFG]` ä¸­
    *   VMODE\[0\] æŽ§åˆ¶MIO15:0ç®¡è„šï¼ŒVMODE\[1\]æŽ§åˆ¶53:16ç®¡è„š

bootrom
-------

[![bootrom_flow.jpg](./zynq hardware -_ boot _ explorer_files/bootrom_flow.jpg)](./zynq hardware -_ boot _ explorer_files/bootrom_flow.jpg)

*   bootromåœ¨æ‰§è¡ŒæœŸé—´DAPå’ŒTAPæ˜¯ä¸å¯ç”¨çš„ã€‚
*   fsbl/user code çš„å¤§å°é™åˆ¶åœ¨192kï¼Œä½†å¦‚æžœæ˜¯åœ¨flashä¸Šç›´æŽ¥è¿è¡Œåˆ™æ²¡æœ‰è¿™ä¸ªé™åˆ¶
    *   æœ¬æ¥256kçš„OCMï¼Œæœ‰é«˜64kåœ¨è¿è¡Œbootromï¼Œæ‰€ä»¥bootromåœ¨æ¬ç§»fsblä»£ç æœŸé—´åªå‰©ä¸‹192KBç©ºé—´äº†ã€‚

### bootromå¤´

bootromå¤´åªåœ¨flashå¯åŠ¨ä¸‹éœ€è¦ï¼Œåœ¨JTAGå¯åŠ¨ä¸‹ä¸éœ€è¦ã€‚

![image] (https://github.com/lovecfcfxyz/Zynq-/tree/master/zynq%20hardware%20-_%20boot%20_%20explorer_files/bootrom_header1.jpg) 

![image] (https://github.com/lovecfcfxyz/Zynq-/tree/master/zynq%20hardware%20-_%20boot%20_%20explorer_files/bootrom_header2.jpg)

#### ä¸­æ–­å‘é‡è¡¨çš„å­˜å‚¨ä½ç½®(0x00 ~ 0x1c, 8ä¸ª4å­—èŠ‚)

å½“ä»£ç è¦è¿è¡Œåœ¨QSPIæˆ–NOR flashæ—¶ï¼Œè¿™éƒ¨åˆ†ç©ºé—´ç”¨äºŽå­˜æ”¾ARMä¸­çš„8ç§[å¼‚å¸¸ä¸­æ–­](http://kcmetercec.top/2018/03/12/linux_kernel_irq_tutorial/#org622942e)ã€‚

#### æ•°æ®å®½åº¦æ£€æµ‹(0x20)

å½“å¯åŠ¨æ–¹å¼ä¸ºQSPIæ—¶ï¼Œæ­¤å¤„å†…å®¹å¿…é¡»ä¸º `0xaa995566` ä»¥å‘ŠçŸ¥bootromå¯ä»¥æ£€æµ‹æ•°æ®å®½åº¦

#### æ–‡ä»¶æ ‡è¯†(0x24)

æ­¤å¤„å€¼æ’å®šä¸º `0x584c4e58` ä»¥å¯¹åº”å­—ç¬¦ä¸² "XLNX",ä»¥å‘ŠçŸ¥æ­¤æ–‡ä»¶ä¸ºzynqçš„å¯åŠ¨æ–‡ä»¶

#### åŠ å¯†é…ç½®(0x28)

*   `0xa5c3c5a3` : fsbl/user code å·²è¢«åŠ å¯†ï¼Œä½¿ç”¨ eFUSE key
*   `0x3a5c3c5a` : fsbl/user code å·²è¢«åŠ å¯†ï¼Œä½¿ç”¨ç”µæºç»´æŒçš„ RAM key
*   å…¶ä»–å€¼: éžåŠ å¯†æ¨¡å¼

#### fsbl/user å®šä¹‰åŒº(0x2c)

æ­¤å€¼å¯ä»¥è¢«fsbl/user æ‰€ä½¿ç”¨ï¼Œbootromå¹¶ä¸ä½¿ç”¨

#### source offset(0x30)

æŒ‡å®šæºç ç›¸å¯¹æ–‡ä»¶èµ·å§‹ä½ç½®çš„åç§»ï¼Œå•ä½ä¸ºå­—èŠ‚ã€‚

*   æ­¤å€¼å¿…é¡»æ˜¯64å­—èŠ‚å¯¹é½ï¼Œå¹¶ä¸”ä½ç½®ä¸èƒ½å°äºŽ `0x8c0`

#### imageé•¿åº¦(0x34)

æŒ‡å®šæ–‡ä»¶é•¿åº¦ï¼Œå•ä½ä¸ºå­—èŠ‚ã€‚

*   å½“å€¼ä¸º0æ—¶ï¼Œbootromä¸ä¼šæ‹·è´ä»£ç åˆ°OCMä¸­ï¼Œè€Œæ˜¯ç›´æŽ¥åœ¨QSPIæˆ–NORflashä¸Šè¿è¡Œã€‚

#### ä¿ç•™(0x38)

å€¼ä¸º0.

#### æ‰§è¡Œçš„èµ·å§‹åœ°å€(0x3c)

æŒ‡å®šä»£ç çš„æ‰§è¡Œåœ°å€ï¼Œå¿…é¡»64å­—èŠ‚å¯¹é½ã€‚

#### imageçš„æ€»å¤§å°(0x40)

è¦è½½å…¥OCMä¸­çš„æ€»å¤§å°ã€‚

*   åœ¨éžå®‰å…¨æ¨¡å¼ä¸‹ï¼Œæ­¤å€¼ä¸Žimageé•¿åº¦ä¸€è‡´
*   åœ¨å®‰å…¨æ¨¡å¼ä¸‹ï¼Œæ­¤å€¼ä¼šå¤§äºŽimageé•¿åº¦

#### ä¿ç•™(0x44)

å€¼ä¸º0.

#### å¤´æ ¡éªŒ(0x48)

è®¡ç®—0x20~0x44ä¹‹å’Œï¼Œç„¶åŽå–åã€‚

#### fsbl/user å®šä¹‰åŒº(0x4c ~ 0x9c)

æ­¤å€¼å¯ä»¥è¢«fsbl/user æ‰€ä½¿ç”¨ï¼Œbootromå¹¶ä¸ä½¿ç”¨

#### å¯„å­˜å™¨åˆå§‹åŒ–å‚æ•°(0xa0~0x89f)

è¿™é‡ŒåŒ…å«äº†256å¯¹ `åœ°å€ï¼Œæ•°æ®` å¯¹ï¼Œç”¨äºŽåœ¨å¯åŠ¨fsbl/user code ä¹‹å‰å…ˆæ¥åˆå§‹åŒ–zynq.

*   å½“åœ°å€ä¸º `0xffffffff` æˆ–éåŽ†åˆ°åˆ—è¡¨å°¾æ—¶ï¼Œbootromé€€å‡ºåˆå§‹åŒ–

#### fsbl/user å®šä¹‰åŒº(0x8a0 ~ 0x8bf)

æ­¤å€¼å¯ä»¥è¢«fsbl/user æ‰€ä½¿ç”¨ï¼Œbootromå¹¶ä¸ä½¿ç”¨

#### ä»£ç çš„èµ·å§‹åœ°å€(0x8c0)

ä»£ç åœ°å€å¿…é¡»å­˜æ”¾äºŽå¤§äºŽæˆ–ç­‰äºŽæ­¤å¤„ï¼Œå¹¶ä¸”ä»¥64ä½å¯¹é½ã€‚

Last Updated 2018-11-12 Mon 08:04.  
Render by [hexo-renderer-org](https://github.com/CodeFalling/hexo-renderer-org) with [Emacs](https://www.gnu.org/software/emacs/) 26.1 ([Org](https://orgmode.org/) mode 9.1.14)

[\# zynq](http://kcmetercec.top/tags/zynq/)

[\[What\]æ•°æ®ç»“æž„ä¸Žç®—æ³• -> æŽ’åº](http://kcmetercec.top/2018/11/07/program_DS_sort/ "[What]æ•°æ®ç»“æž„ä¸Žç®—æ³• -> æŽ’åº")

[zynq petalinux -> boot](http://kcmetercec.top/2018/11/09/processor_zynq_petalinux_boot/ "zynq petalinux -> boot")

Emoji | Preview

_ðŸ˜€__ðŸ˜ƒ__ðŸ˜„__ðŸ˜__ðŸ˜†__ðŸ˜…__ðŸ˜‚__ðŸ˜Š__ðŸ˜‡__ðŸ˜‰__ðŸ˜Œ__ðŸ˜__ðŸ˜˜__ðŸ˜—__ðŸ˜™__ðŸ˜š__ðŸ˜‹__ðŸ˜œ__ðŸ˜__ðŸ˜›__ðŸ˜Ž__ðŸ˜__ðŸ˜’__ðŸ˜ž__ðŸ˜”__ðŸ˜Ÿ__ðŸ˜•__ðŸ˜£__ðŸ˜–__ðŸ˜«__ðŸ˜©__ðŸ˜ __ðŸ˜¡__ðŸ˜¶__ðŸ˜__ðŸ˜‘__ðŸ˜¯__ðŸ˜¦__ðŸ˜§__ðŸ˜®__ðŸ˜²__ðŸ˜µ__ðŸ˜³__ðŸ˜±__ðŸ˜¨__ðŸ˜°__ðŸ˜¢__ðŸ˜¥__ðŸ˜­__ðŸ˜“__ðŸ˜ª__ðŸ˜´__ðŸ˜·__ðŸ˜ˆ__ðŸ˜º__ðŸ˜¸__ðŸ˜¹__ðŸ˜»__ðŸ˜¼__ðŸ˜½__ðŸ™€__ðŸ˜¿__ðŸ˜¾__ðŸ±__ðŸ­__ðŸ®__ðŸµ__âœ‹__âœŠ__âœŒï¸__ðŸ‘†__ðŸ‘‡__ðŸ‘ˆ__ðŸ‘‰__ðŸ‘Š__ðŸ‘‹__ðŸ‘__ðŸ‘__ðŸ‘__ðŸ‘Ž__ðŸ‘Œ__ðŸ™__ðŸ‘‚__ðŸ‘€__ðŸ‘ƒ__ðŸ‘„__ðŸ‘…__â¤ï¸__ðŸ’˜__ðŸ’–__â­ï¸__âœ¨__âš¡ï¸__â˜€ï¸__â˜ï¸__â„ï¸__â˜”ï¸__â˜•ï¸__âœˆï¸__âš“ï¸__âŒšï¸__â˜Žï¸__âŒ›ï¸__âœ‰ï¸__âœ‚ï¸__âœ’ï¸__âœï¸__âŒ__â™»ï¸__âœ…__âŽ__â“‚ï¸__â„¹ï¸__â„¢ï¸__Â©ï¸__Â®ï¸_

å›žå¤

å¿«æ¥åšç¬¬ä¸€ä¸ªè¯„è®ºçš„äººå§~

Powered By [Valine](https://valine.js.org/)  
v1.3.4

*   Table of Contents
*   Overview

![kcmetercec](./zynq hardware -_ boot _ explorer_files/16881795)

kcmetercec

æˆ‘çš„ä¸–ç•Œ

[160 posts](http://kcmetercec.top/archives/)

[96 categories](http://kcmetercec.top/categories/index.html)

[35 tags](http://kcmetercec.top/tags/index.html)

[RSS](http://kcmetercec.top/atom.xml)

[GitHub](https://github.com/KcMeterCEC "GitHub")

 [![Creative Commons](./zynq hardware -_ boot _ explorer_files/cc-by-nc.svg)](https://creativecommons.org/licenses/by-nc/4.0/) 

1.  [1. æ•´ä½“æµç¨‹](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#orgc376886)
    1.  [1.1. æ¦‚è§ˆ](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#orga0ede36)
    2.  [1.2. PSç«¯ç¡¬ä»¶å¯åŠ¨](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#orgb1772df)
    3.  [1.3. PSç«¯è½¯ä»¶å¯åŠ¨](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#orgeb46b98)
    4.  [1.4. å¯åŠ¨ä»‹è´¨çš„å†…å®¹](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#orgf9d8e52)
    5.  [1.5. å¯åŠ¨æ¨¡å¼](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#orgca9ffa1)
    6.  [1.6. BootROMçš„æ‰§è¡Œ](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#orgf32c65e)
    7.  [1.7. PLçš„é…ç½®è·¯å¾„](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#orgec9270d)
    8.  [1.8. è®¾å¤‡é…ç½®æŽ¥å£](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#org722db8d)
2.  [2. ä¸Šç”µåˆ°bootrom](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#org39a8c70)
    1.  [2.1. ç”µæºéœ€æ±‚](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#org544f181)
    2.  [2.2. æ—¶é’Ÿ](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#org7938146)
    3.  [2.3. å¤ä½](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#org5c10aa6)
    4.  [2.4. å¯åŠ¨æ¨¡å¼ç®¡è„š](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#orgb3da33f)
3.  [3. bootrom](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#org62e0a9c)
    1.  [3.1. bootromå¤´](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#orge16bef2)
        1.  [3.1.1. ä¸­æ–­å‘é‡è¡¨çš„å­˜å‚¨ä½ç½®(0x00 ~ 0x1c, 8ä¸ª4å­—èŠ‚)](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#org0badeb5)
        2.  [3.1.2. æ•°æ®å®½åº¦æ£€æµ‹(0x20)](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#org0d11179)
        3.  [3.1.3. æ–‡ä»¶æ ‡è¯†(0x24)](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#orgaa19197)
        4.  [3.1.4. åŠ å¯†é…ç½®(0x28)](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#orgc1f7329)
        5.  [3.1.5. fsbl/user å®šä¹‰åŒº(0x2c)](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#org260ac76)
        6.  [3.1.6. source offset(0x30)](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#orgd58c94c)
        7.  [3.1.7. imageé•¿åº¦(0x34)](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#org9530e73)
        8.  [3.1.8. ä¿ç•™(0x38)](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#orgc7b6d74)
        9.  [3.1.9. æ‰§è¡Œçš„èµ·å§‹åœ°å€(0x3c)](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#orgbbcbad3)
        10.  [3.1.10. imageçš„æ€»å¤§å°(0x40)](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#org728c501)
        11.  [3.1.11. ä¿ç•™(0x44)](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#orga3fc8f1)
        12.  [3.1.12. å¤´æ ¡éªŒ(0x48)](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#org080336f)
        13.  [3.1.13. fsbl/user å®šä¹‰åŒº(0x4c ~ 0x9c)](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#orga488f32)
        14.  [3.1.14. å¯„å­˜å™¨åˆå§‹åŒ–å‚æ•°(0xa0~0x89f)](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#org7797685)
        15.  [3.1.15. fsbl/user å®šä¹‰åŒº(0x8a0 ~ 0x8bf)](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#orge4d9bb7)
        16.  [3.1.16. ä»£ç çš„èµ·å§‹åœ°å€(0x8c0)](http://kcmetercec.top/2018/11/08/processor_zynq_hd_boot/#orgcf9b01a)

Â© 2018 â€” 2019 kcmetercec | Hosted by [Coding Pages](https://pages.coding.me/)

Powered by [Hexo](https://hexo.io/)

|

Theme â€” [NexT.Gemini](https://github.com/iissnan/hexo-theme-next) v5.1.4

2835 4512

if (Object.prototype.toString.call(window.Promise) !== '\[object Function\]') { window.Promise = null; } var GUEST = \['nick','mail','link'\]; var guest = 'nick,mail,link'; guest = guest.split(',').filter(item=>{ return GUEST.indexOf(item)>-1; }); new Valine({ el: '#comments' , verify: false, notify: false, appId: 'HKCPHADgp5CIhX5YI6qBfUgJ-gzGzoHsz', appKey: 'z50aXrM2NQ2DbuiJsUfQMbiy', placeholder: 'Just go go', avatar:'mm', guest\_info:guest, pageSize:'10' || 10, }); // Popup Window; var isfetched = false; var isXml = true; // Search DB path; var search\_path = "search.xml"; if (search\_path.length === 0) { search\_path = "search.xml"; } else if (/json$/i.test(search\_path)) { isXml = false; } var path = "/" + search\_path; // monitor main search box; var onPopupClose = function (e) { $('.popup').hide(); $('#local-search-input').val(''); $('.search-result-list').remove(); $('#no-result').remove(); $(".local-search-pop-overlay").remove(); $('body').css('overflow', ''); } function proceedsearch() { $("body") .append('<div class="search-popup-overlay local-search-pop-overlay"></div>') .css('overflow', 'hidden'); $('.search-popup-overlay').click(onPopupClose); $('.popup').toggle(); var $localSearchInput = $('#local-search-input'); $localSearchInput.attr("autocapitalize", "none"); $localSearchInput.attr("autocorrect", "off"); $localSearchInput.focus(); } // search function; var searchFunc = function(path, search\_id, content\_id) { 'use strict'; // start loading animation $("body") .append('<div class="search-popup-overlay local-search-pop-overlay">' + '<div id="search-loading-icon">' + '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' + '</div>' + '</div>') .css('overflow', 'hidden'); $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center'); $.ajax({ url: path, dataType: isXml ? "xml" : "json", async: true, success: function(res) { // get the contents from search data isfetched = true; $('.popup').detach().appendTo('.header-inner'); var datas = isXml ? $("entry", res).map(function() { return { title: $("title", this).text(), content: $("content",this).text(), url: $("url" , this).text() }; }).get() : res; var input = document.getElementById(search\_id); var resultContent = document.getElementById(content\_id); var inputEventFunction = function() { var searchText = input.value.trim().toLowerCase(); var keywords = searchText.split(/\[\\s\\-\]+/); if (keywords.length > 1) { keywords.push(searchText); } var resultItems = \[\]; if (searchText.length > 0) { // perform local searching datas.forEach(function(data) { var isMatch = false; var hitCount = 0; var searchTextCount = 0; var title = data.title.trim(); var titleInLowerCase = title.toLowerCase(); var content = data.content.trim().replace(/<\[^>\]+>/g,""); var contentInLowerCase = content.toLowerCase(); var articleUrl = decodeURIComponent(data.url); var indexOfTitle = \[\]; var indexOfContent = \[\]; // only match articles with not empty titles if(title != '') { keywords.forEach(function(keyword) { function getIndexByWord(word, text, caseSensitive) { var wordLen = word.length; if (wordLen === 0) { return \[\]; } var startPosition = 0, position = \[\], index = \[\]; if (!caseSensitive) { text = text.toLowerCase(); word = word.toLowerCase(); } while ((position = text.indexOf(word, startPosition)) > -1) { index.push({position: position, word: word}); startPosition = position + wordLen; } return index; } indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false)); indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false)); }); if (indexOfTitle.length > 0 || indexOfContent.length > 0) { isMatch = true; hitCount = indexOfTitle.length + indexOfContent.length; } } // show search results if (isMatch) { // sort index by position of keyword \[indexOfTitle, indexOfContent\].forEach(function (index) { index.sort(function (itemLeft, itemRight) { if (itemRight.position !== itemLeft.position) { return itemRight.position - itemLeft.position; } else { return itemLeft.word.length - itemRight.word.length; } }); }); // merge hits into slices function mergeIntoSlice(text, start, end, index) { var item = index\[index.length - 1\]; var position = item.position; var word = item.word; var hits = \[\]; var searchTextCountInSlice = 0; while (position + word.length <= end && index.length != 0) { if (word === searchText) { searchTextCountInSlice++; } hits.push({position: position, length: word.length}); var wordEnd = position + word.length; // move to next position of hit index.pop(); while (index.length != 0) { item = index\[index.length - 1\]; position = item.position; word = item.word; if (wordEnd > position) { index.pop(); } else { break; } } } searchTextCount += searchTextCountInSlice; return { hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice }; } var slicesOfTitle = \[\]; if (indexOfTitle.length != 0) { slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle)); } var slicesOfContent = \[\]; while (indexOfContent.length != 0) { var item = indexOfContent\[indexOfContent.length - 1\]; var position = item.position; var word = item.word; // cut out 100 characters var start = position - 20; var end = position + 80; if(start < 0){ start = 0; } if (end < position + word.length) { end = position + word.length; } if(end > content.length){ end = content.length; } slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent)); } // sort slices in content by search text's count and hits' count slicesOfContent.sort(function (sliceLeft, sliceRight) { if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) { return sliceRight.searchTextCount - sliceLeft.searchTextCount; } else if (sliceLeft.hits.length !== sliceRight.hits.length) { return sliceRight.hits.length - sliceLeft.hits.length; } else { return sliceLeft.start - sliceRight.start; } }); // select top N slices in content var upperBound = parseInt('1'); if (upperBound >= 0) { slicesOfContent = slicesOfContent.slice(0, upperBound); } // highlight title and content function highlightKeyword(text, slice) { var result = ''; var prevEnd = slice.start; slice.hits.forEach(function (hit) { result += text.substring(prevEnd, hit.position); var end = hit.position + hit.length; result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>'; prevEnd = end; }); result += text.substring(prevEnd, slice.end); return result; } var resultItem = ''; if (slicesOfTitle.length != 0) { resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle\[0\]) + "</a>"; } else { resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) { resultItem += "<a href='" + articleUrl + "'>" + "<p class=\\"search-result\\">" + highlightKeyword(content, slice) + "...</p>" + "</a>"; }); resultItem += "</li>"; resultItems.push({ item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length }); } }) }; if (keywords.length === 1 && keywords\[0\] === "") { resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' } else if (resultItems.length === 0) { resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' } else { resultItems.sort(function (resultLeft, resultRight) { if (resultLeft.searchTextCount !== resultRight.searchTextCount) { return resultRight.searchTextCount - resultLeft.searchTextCount; } else if (resultLeft.hitCount !== resultRight.hitCount) { return resultRight.hitCount - resultLeft.hitCount; } else { return resultRight.id - resultLeft.id; } }); var searchResultList = '<ul class=\\"search-result-list\\">'; resultItems.forEach(function (result) { searchResultList += result.item; }) searchResultList += "</ul>"; resultContent.innerHTML = searchResultList; } } if ('auto' === 'auto') { input.addEventListener('input', inputEventFunction); } else { $('.search-icon').click(inputEventFunction); input.addEventListener('keypress', function (event) { if (event.keyCode === 13) { inputEventFunction(); } }); } // remove loading animation $(".local-search-pop-overlay").remove(); $('body').css('overflow', ''); proceedsearch(); } }); } // handle and trigger popup window; $('.popup-trigger').click(function(e) { e.stopPropagation(); if (isfetched === false) { searchFunc(path, 'local-search-input', 'local-search-result'); } else { proceedsearch(); }; }); $('.popup-btn-close').click(onPopupClose); $('.popup').click(function(e){ e.stopPropagation(); }); $(document).on('keyup', function (event) { var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible'); if (shouldDismissSearchPopup) { onPopupClose(); } }); AV.initialize("HKCPHADgp5CIhX5YI6qBfUgJ-gzGzoHsz", "z50aXrM2NQ2DbuiJsUfQMbiy"); function showTime(Counter) { var query = new AV.Query(Counter); var entries = \[\]; var $visitors = $(".leancloud\_visitors"); $visitors.each(function () { entries.push( $(this).attr("id").trim() ); }); query.containedIn('url', entries); query.find() .done(function (results) { var COUNT\_CONTAINER\_REF = '.leancloud-visitors-count'; if (results.length === 0) { $visitors.find(COUNT\_CONTAINER\_REF).text(0); return; } for (var i = 0; i < results.length; i++) { var item = results\[i\]; var url = item.get('url'); var time = item.get('time'); var element = document.getElementById(url); $(element).find(COUNT\_CONTAINER\_REF).text(time); } for(var i = 0; i < entries.length; i++) { var url = entries\[i\]; var element = document.getElementById(url); var countSpan = $(element).find(COUNT\_CONTAINER\_REF); if( countSpan.text() == '') { countSpan.text(0); } } }) .fail(function (object, error) { console.log("Error: " + error.code + " " + error.message); }); } function addCount(Counter) { var $visitors = $(".leancloud\_visitors"); var url = $visitors.attr('id').trim(); var title = $visitors.attr('data-flag-title').trim(); var query = new AV.Query(Counter); query.equalTo("url", url); query.find({ success: function(results) { if (results.length > 0) { var counter = results\[0\]; counter.fetchWhenSave(true); counter.increment("time"); counter.save(null, { success: function(counter) { var $element = $(document.getElementById(url)); $element.find('.leancloud-visitors-count').text(counter.get('time')); }, error: function(counter, error) { console.log('Failed to save Visitor num, with error message: ' + error.message); } }); } else { var newcounter = new Counter(); /\* Set ACL \*/ var acl = new AV.ACL(); acl.setPublicReadAccess(true); acl.setPublicWriteAccess(true); newcounter.setACL(acl); /\* End Set ACL \*/ newcounter.set("title", title); newcounter.set("url", url); newcounter.set("time", 1); newcounter.save(null, { success: function(newcounter) { var $element = $(document.getElementById(url)); $element.find('.leancloud-visitors-count').text(newcounter.get('time')); }, error: function(newcounter, error) { console.log('Failed to create'); } }); } }, error: function(error) { console.log('Error:' + error.code + " " + error.message); } }); } $(function() { var Counter = AV.Object.extend("Counter"); if ($('.leancloud\_visitors').length == 1) { addCount(Counter); } else if ($('.post-title-link').length > 1) { showTime(Counter); } });
